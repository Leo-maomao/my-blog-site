<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文章详情 · 毛毛的产品日记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 引入 Remix Icon 图标库 -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <!-- 引入自定义样式 -->
  <link rel="stylesheet" href="./css/style.css">
  <!-- 引入 Quill 样式（用于渲染富文本） -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    .post-header {
      padding-top: 40px;
      padding-bottom: 30px;
      text-align: center;
    }

    .post-category-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .badge--diary {
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
    }

    .badge--experience {
      background: rgba(16, 185, 129, 0.12);
      color: #059669;
    }

    .badge--notes {
      background: rgba(245, 158, 11, 0.12);
      color: #d97706;
    }

    .post-title {
      font-size: 36px;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 16px;
      color: var(--text-main);
    }

    .post-meta {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      font-size: 14px;
      color: var(--text-muted);
    }

    .post-meta i {
      margin-right: 6px;
    }

    .post-cover {
      width: 100%;
      max-width: 900px;
      margin: 0 auto 40px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .post-cover img {
      width: 100%;
      height: auto;
      display: block;
    }

    .post-content {
      max-width: 780px;
      margin: 0 auto;
      padding: 0 20px 60px;
      font-size: 16px;
      line-height: 1.8;
      color: var(--text-main);
    }

    .post-content .ql-editor {
      padding: 0;
      font-size: 16px;
      line-height: 1.8;
    }

    .post-content h1,
    .post-content h2,
    .post-content h3,
    .post-content h4,
    .post-content h5,
    .post-content h6 {
      margin-top: 36px;
      margin-bottom: 16px;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-main);
    }

    .post-content h1 {
      font-size: 28px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .post-content h2 {
      font-size: 24px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f1f5f9;
    }

    .post-content h3 {
      font-size: 20px;
    }

    .post-content h4 {
      font-size: 18px;
    }

    .post-content h5 {
      font-size: 16px;
    }

    .post-content h6 {
      font-size: 14px;
      color: var(--text-sub);
    }

    .post-content p {
      margin-bottom: 16px;
    }

    .post-content img {
      max-width: 100%;
      height: auto;
      margin: 24px auto;
      display: block;
    }

    /* 支持自定义图片尺寸 */
    .post-content img[width] {
      width: auto;
      max-width: 100%;
    }

    .post-content img[height] {
      height: auto;
    }

    .post-content blockquote {
      border-left: 4px solid var(--accent);
      padding-left: 20px;
      margin: 30px 0;
      color: var(--text-sub);
      font-style: italic;
    }

    .post-content code {
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
    }

    .post-content pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 30px 0;
    }

    .post-content pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .post-actions {
      max-width: 780px;
      margin: 0 auto 40px;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 999px;
      background: #f3f4f6;
      color: var(--text-main);
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-back:hover {
      background: #e5e7eb;
      transform: translateX(-2px);
    }

    .post-actions-right {
      display: flex;
      gap: 12px;
    }

    .btn-edit, .btn-delete {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn-edit {
      background: #eff6ff;
      color: #2563eb;
    }

    .btn-edit:hover {
      background: #dbeafe;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.15);
    }

    .btn-delete {
      background: #fef2f2;
      color: #dc2626;
    }

    .btn-delete:hover {
      background: #fee2e2;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(220, 38, 38, 0.15);
    }

    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 16px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-container {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .post-title {
        font-size: 28px;
      }

      .post-meta {
        flex-direction: column;
        gap: 8px;
      }

      .post-content {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
<div class="page-wrap">
  <!-- 顶部导航 -->
  <header class="site-header">
    <div class="container nav-inner">
      <div class="brand">
        <a href="./index.html">毛毛的产品日记</a>
      </div>
      <nav class="nav-links">
        <a href="./index.html" class="nav-link">首页</a>
        <a href="./diary.html" class="nav-link">产品日记</a>
        <a href="./experience.html" class="nav-link">产品体验</a>
        <a href="./notes.html" class="nav-link">随手记录</a>
      </nav>
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        ☰
      </button>
    </div>
  </header>

  <main>
    <!-- 加载中状态 -->
    <div class="loading-container" id="loadingContainer">
      <div class="loading-spinner"></div>
      <p>加载中...</p>
    </div>

    <!-- 文章内容容器 -->
    <div id="postContainer" style="display: none;">
      <section class="post-header">
        <div class="container">
          <h1 class="post-title" id="postTitle"></h1>
          <div class="post-meta">
            <span><i class="ri-calendar-line"></i><span id="postDate"></span></span>
            <span><i class="ri-time-line"></i><span id="postReadTime"></span></span>
          </div>
        </div>
      </section>

      <div id="postCoverContainer" style="display: none;">
        <div class="post-cover">
          <img id="postCoverImg" alt="文章封面">
        </div>
      </div>

      <section class="post-content">
        <div class="container">
          <div class="ql-editor" id="postContentHtml"></div>
        </div>
      </section>

      <div class="post-actions">
        <button class="btn-back" id="btnBack">
          <i class="ri-arrow-left-line"></i> 返回列表
        </button>
        <div class="post-actions-right">
          <button class="btn-edit" id="btnEdit" style="display: none;">
            <i class="ri-edit-line"></i> 编辑
          </button>
          <button class="btn-delete" id="btnDelete" style="display: none;">
            <i class="ri-delete-bin-line"></i> 删除
          </button>
        </div>
      </div>
    </div>

    <!-- 错误状态 -->
    <div class="error-container" id="errorContainer" style="display: none;">
      <div class="error-icon">
        <i class="ri-file-warning-line"></i>
      </div>
      <h2>文章不存在</h2>
      <p>抱歉，找不到这篇文章。</p>
      <button class="btn-back" onclick="window.location.href='./index.html'" style="margin-top: 20px;">
        <i class="ri-home-line"></i> 返回首页
      </button>
    </div>
  </main>

  <!-- 移动端菜单 -->
  <nav class="mobile-menu" id="mobileMenu">
    <a href="./index.html" class="mobile-menu-link">首页</a>
    <a href="./diary.html" class="mobile-menu-link">产品日记</a>
    <a href="./experience.html" class="mobile-menu-link">产品体验</a>
    <a href="./notes.html" class="mobile-menu-link">随手记录</a>
  </nav>

  <!-- 回到顶部按钮 -->
  <button class="back-to-top" id="backToTop" aria-label="回到顶部">
    <i class="ri-arrow-up-line"></i>
  </button>

  <!-- 意见反馈按钮 -->
  <div class="feedback-btn" id="feedbackBtn" title="意见反馈">
    <i class="ri-feedback-line"></i>
  </div>

  <!-- 意见反馈弹窗 -->
  <div id="feedbackModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <h3>意见反馈</h3>
        <i class="ri-close-line modal-close" id="feedbackModalClose"></i>
      </div>
      <div class="modal-body">
        <div class="modal-input-group">
          <label>反馈内容 <span style="color:red">*</span></label>
          <textarea id="feedbackContent" class="modal-input" placeholder="请描述您的问题、建议或想法" style="height: 120px; resize: none;" maxlength="500"></textarea>
        </div>
        <div class="modal-input-group">
          <label>联系方式 (选填)</label>
          <input id="feedbackContact" class="modal-input" placeholder="邮箱或微信号，方便我们回复您" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" id="feedbackCancelBtn">取消</button>
        <button class="modal-btn confirm" id="feedbackSubmitBtn">提交反馈</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container footer-inner">
      <div>© 2025 写给自己的产品日记</div>
      <div class="footer-links">
        <a href="https://my-nav-site.leo-maomao.workers.dev/" target="_blank" rel="noopener noreferrer">毛毛的导航站</a>
        <a href="https://github.com/Leo-maomao" target="_blank" rel="noopener noreferrer">GitHub</a>
      </div>
    </div>
  </footer>
</div>

<script>
  // 移动端菜单功能
  (function() {
    var toggleBtn = document.getElementById('mobileMenuToggle');
    var mobileMenu = document.getElementById('mobileMenu');

    if (!toggleBtn || !mobileMenu) return;

    toggleBtn.addEventListener('click', function() {
      mobileMenu.classList.toggle('active');
    });

    // 点击菜单链接后关闭菜单
    var mobileLinks = mobileMenu.querySelectorAll('.mobile-menu-link');
    for (var i = 0; i < mobileLinks.length; i++) {
      mobileLinks[i].addEventListener('click', function() {
        mobileMenu.classList.remove('active');
      });
    }

    // 点击页面其他区域关闭菜单
    document.addEventListener('click', function(e) {
      if (!mobileMenu.contains(e.target) && !toggleBtn.contains(e.target)) {
        mobileMenu.classList.remove('active');
      }
    });
  })();

  // 回到顶部按钮功能
  (function() {
    var backToTopBtn = document.getElementById('backToTop');

    if (!backToTopBtn) return;

    window.addEventListener('scroll', function() {
      if (window.scrollY > 300) {
        backToTopBtn.classList.add('visible');
      } else {
        backToTopBtn.classList.remove('visible');
      }
    });

    backToTopBtn.addEventListener('click', function() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  })();
</script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- 引入核心脚本 -->
<script src="./js/script.js"></script>

<script>
  // 加载文章详情
  (function() {
    // 使用全局共享的 Supabase 客户端
    var supabase = window.blogSupabaseClient;

    var loadingContainer = document.getElementById('loadingContainer');
    var postContainer = document.getElementById('postContainer');
    var errorContainer = document.getElementById('errorContainer');
    var btnBack = document.getElementById('btnBack');
    var btnEdit = document.getElementById('btnEdit');
    var btnDelete = document.getElementById('btnDelete');

    // 检查用户登录状态并显示编辑/删除按钮
    async function checkAuthAndShowButtons(postId) {
      try {
        var { data: session } = await supabase.auth.getSession();
        if (session && session.session) {
          // 用户已登录，显示按钮
          btnEdit.style.display = 'inline-flex';
          btnDelete.style.display = 'inline-flex';

          // 编辑按钮
          btnEdit.onclick = function() {
            window.location.href = './admin.html?edit=' + postId;
          };

          // 删除按钮
          btnDelete.onclick = function() {
            if (confirm('确定要删除这篇文章吗？此操作无法撤销。')) {
              deletePost(postId);
            }
          };
        }
      } catch (e) {
        console.log('[Post] 未登录，隐藏编辑按钮');
      }
    }

    // 删除文章
    async function deletePost(postId) {
      try {
        var { error } = await supabase
          .from('blog_posts')
          .delete()
          .eq('id', postId);

        if (error) throw error;

        alert('文章已删除');
        // 返回列表页
        var currentCategory = document.getElementById('postCategory')?.textContent || '';
        var categoryMap = {
          '产品日记': './diary.html',
          '产品体验': './experience.html',
          '随手记录': './notes.html'
        };
        window.location.href = categoryMap[currentCategory] || './index.html';
      } catch (e) {
        alert('删除失败：' + e.message);
      }
    }

    // 获取URL参数
    function getQueryParam(param) {
      var urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // 分类配置
    var categoryConfig = {
      'diary': { name: '产品日记', class: 'badge--diary', page: './diary.html' },
      'experience': { name: '产品体验', class: 'badge--experience', page: './experience.html' },
      'notes': { name: '随手记录', class: 'badge--notes', page: './notes.html' }
    };

    // 返回按钮
    btnBack.addEventListener('click', function() {
      window.history.back();
    });

    // 立即开始加载文章
    async function loadPost() {
      // 等待 Supabase 客户端初始化（最多等待5秒）
      var attempts = 0;
      var maxAttempts = 50;
      while (!window.blogSupabaseClient && attempts < maxAttempts) {
        await new Promise(function(resolve) { setTimeout(resolve, 100); });
        attempts++;
      }

      if (!window.blogSupabaseClient) {
        showError('Supabase 客户端初始化失败');
        return;
      }
      var postId = getQueryParam('id');

      if (!postId) {
        showError('缺少文章ID');
        return;
      }

      console.log('[Post] 加载文章 ID:', postId);

      try {
        var { data: post, error } = await window.blogSupabaseClient
          .from('blog_posts')
          .select('*')
          .eq('id', postId)
          .single();

        if (error) throw error;

        if (!post) {
          showError('文章不存在');
          return;
        }

        console.log('[Post] 文章加载成功:', post);

        // 渲染文章
        renderPost(post);

      } catch (error) {
        console.error('[Post] 加载失败:', error);
        showError('加载失败: ' + error.message);
      }
    }

    function renderPost(post) {
      // 更新标题
      document.title = post.title + ' · 毛毛的产品日记';
      document.getElementById('postTitle').textContent = post.title || '无标题';

      // 分类配置（用于返回按钮跳转）
      var category = categoryConfig[post.category];
      if (category) {
        // 更新返回按钮跳转
        btnBack.onclick = function() {
          window.location.href = category.page;
        };
      }

      // 编辑和删除按钮（仅登录用户可见）
      checkAuthAndShowButtons(post.id);

      // 日期
      var createdDate = new Date(post.created_at);
      document.getElementById('postDate').textContent = createdDate.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      // 阅读时间（简单估算：300字/分钟）
      var textLength = (post.content || '').replace(/<[^>]*>/g, '').length;
      var readTime = Math.max(1, Math.ceil(textLength / 300));
      document.getElementById('postReadTime').textContent = readTime + ' 分钟阅读';

      // 封面图
      if (post.cover) {
        document.getElementById('postCoverImg').src = post.cover;
        document.getElementById('postCoverContainer').style.display = 'block';
      }

      // 文章内容
      document.getElementById('postContentHtml').innerHTML = post.content || '<p>暂无内容</p>';

      // 显示文章，隐藏加载
      loadingContainer.style.display = 'none';
      postContainer.style.display = 'block';
    }

    function showError(message) {
      loadingContainer.style.display = 'none';
      errorContainer.style.display = 'block';
      console.error('[Post] ' + message);
    }

    // 立即开始加载
    loadPost();
  })();

// 意见反馈功能
(function() {
  var feedbackBtn = document.getElementById("feedbackBtn");
  var modal = document.getElementById("feedbackModal");
  var close = document.getElementById("feedbackModalClose");
  var cancel = document.getElementById("feedbackCancelBtn");
  var submit = document.getElementById("feedbackSubmitBtn");
  var contentInput = document.getElementById("feedbackContent");
  var contactInput = document.getElementById("feedbackContact");

  if (!feedbackBtn || !modal) return;

  feedbackBtn.onclick = function() { modal.classList.add("is-visible"); };

  function closeModal() {
    modal.classList.remove("is-visible");
    setTimeout(function() {
      if (contentInput) contentInput.value = "";
      if (contactInput) contactInput.value = "";
    }, 200);
  }

  if (close) close.onclick = closeModal;
  if (cancel) cancel.onclick = closeModal;

  if (submit) submit.onclick = async function() {
    var content = contentInput.value.trim();
    if (!content) { Toast.error("请输入反馈内容"); return; }

    submit.disabled = true;
    submit.textContent = "提交中...";

    try {
      var result = await DataService.submitFeedback(content, contactInput.value.trim());
      if (result.success) {
        Toast.success("反馈提交成功，感谢您的反馈！");
        closeModal();
      } else {
        Toast.error("提交失败：" + (result.error || "未知错误"));
      }
    } catch (e) {
      Toast.error("提交失败：" + e.message);
    } finally {
      submit.disabled = false;
      submit.textContent = "提交反馈";
    }
  };

  window.addEventListener("scroll", function() {
    if (window.scrollY > 300) {
      feedbackBtn.classList.add("move-up");
    } else {
      feedbackBtn.classList.remove("move-up");
    }
  });
})();
</script>
</body>
</html>
